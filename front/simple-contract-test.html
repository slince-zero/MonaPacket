<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monad çº¢åŒ… - ç®€åŒ–æµ‹è¯•</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #000000;
            border: 4px solid #ffffff;
            box-shadow: 8px 8px 0px #01DB83;
            padding: 40px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #FFD641;
            text-shadow: 4px 4px 0px #000000;
            text-align: center;
        }

        .section {
            background: #ffffff;
            border: 3px solid #000000;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 4px 4px 0px #01DB83;
        }

        .section h3 {
            color: #000000;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            color: #000000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 3px solid #000000;
            background: #ffffff;
            color: #000000;
            font-weight: 700;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            box-shadow: 2px 2px 0px #000000;
        }

        .button {
            background: #FFD641;
            color: #000000;
            border: 4px solid #000000;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 6px 6px 0px #01DB83;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: inherit;
            width: 100%;
            margin-bottom: 16px;
        }

        .button:hover {
            transform: translate(-3px, -3px);
            box-shadow: 9px 9px 0px #01DB83;
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 6px 6px 0px #666666;
        }

        .button.secondary {
            background: #01DB83;
        }

        .status {
            padding: 16px;
            margin: 16px 0;
            border: 3px solid #000000;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 4px 4px 0px #000000;
        }

        .status.success {
            background: #01DB83;
            color: #000000;
        }

        .status.error {
            background: #ff4444;
            color: #ffffff;
        }

        .status.info {
            background: #FFD641;
            color: #000000;
        }

        .console-log {
            background: #000000;
            border: 2px solid #01DB83;
            padding: 20px;
            margin-top: 24px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #01DB83;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            word-break: break-all;
        }

        .hidden {
            display: none;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .info-value {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            word-break: break-all;
            text-align: right;
            max-width: 60%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">MONAD RED PACKET</div>
        
        <!-- åˆçº¦ä¿¡æ¯ -->
        <div class="section">
            <h3>CONTRACT INFO</h3>
            <div class="info-item">
                <span class="info-label">ADDRESS:</span>
                <span class="info-value">0xd89C5C99B854470a3ea68b533441898Dee74B681</span>
            </div>
            <div class="info-item">
                <span class="info-label">NETWORK:</span>
                <span class="info-value">Monad Testnet (5555)</span>
            </div>
        </div>

        <!-- é’±åŒ…çŠ¶æ€ -->
        <div class="section">
            <h3>WALLET STATUS</h3>
            <div id="walletInfo">
                <div class="info-item">
                    <span class="info-label">STATUS:</span>
                    <span class="info-value" id="walletStatus">Not Connected</span>
                </div>
                <div class="info-item hidden" id="addressInfo">
                    <span class="info-label">ADDRESS:</span>
                    <span class="info-value" id="walletAddress">-</span>
                </div>
                <div class="info-item hidden" id="networkInfo">
                    <span class="info-label">NETWORK:</span>
                    <span class="info-value" id="networkName">-</span>
                </div>
                <div class="info-item hidden" id="balanceInfo">
                    <span class="info-label">BALANCE:</span>
                    <span class="info-value" id="walletBalance">-</span>
                </div>
            </div>
            
            <button id="connectBtn" class="button">CONNECT WALLET</button>
            <button id="disconnectBtn" class="button secondary hidden">DISCONNECT</button>
        </div>

        <!-- åˆ›å»ºçº¢åŒ… -->
        <div class="section">
            <h3>CREATE RED PACKET</h3>
            
            <div class="form-group">
                <label class="form-label">RECIPIENT ADDRESS</label>
                <input type="text" id="recipient" class="form-input" 
                       placeholder="0x742d35Cc6634C0532925a3b8D..." 
                       value="0x742d35Cc6634C0532925a3b8D123456789ABCDEF0">
            </div>
            
            <div class="form-group">
                <label class="form-label">AMOUNT (MON)</label>
                <input type="number" id="amount" class="form-input" 
                       value="0.001" min="0.001" step="0.001">
            </div>
            
            <button id="createBtn" class="button" disabled>CREATE RED PACKET</button>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="statusMessage" class="status hidden"></div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div class="section hidden" id="resultSection">
            <h3>TRANSACTION RESULT</h3>
            <div class="info-item">
                <span class="info-label">TX HASH:</span>
                <span class="info-value" id="txHash">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">STATUS:</span>
                <span class="info-value" id="txStatus">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">BLOCK:</span>
                <span class="info-value" id="blockNumber">-</span>
            </div>
        </div>

        <!-- æ§åˆ¶å°æ—¥å¿— -->
        <div class="console-log">
            <div style="color: #FFD641; font-weight: bold; margin-bottom: 12px;">CONSOLE LOG:</div>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONTRACT_ADDRESS = '0xd89C5C99B854470a3ea68b533441898Dee74B681';
        const MONAD_CHAIN_ID = '0x15B3'; // 5555 in hex

        let walletConnected = false;
        let userAddress = '';
        let currentChainId = '';

        // æ—¥å¿—å‡½æ•°
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.classList.remove('hidden');
        }

        // éšè—çŠ¶æ€æ¶ˆæ¯
        function hideStatus() {
            document.getElementById('statusMessage').classList.add('hidden');
        }

        // æ›´æ–°é’±åŒ…UI
        function updateWalletUI() {
            const statusElement = document.getElementById('walletStatus');
            const addressElement = document.getElementById('walletAddress');
            const networkElement = document.getElementById('networkName');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const createBtn = document.getElementById('createBtn');

            if (walletConnected) {
                statusElement.textContent = 'Connected';
                addressElement.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                networkElement.textContent = currentChainId === MONAD_CHAIN_ID ? 'Monad Testnet' : 'Wrong Network';
                
                document.getElementById('addressInfo').classList.remove('hidden');
                document.getElementById('networkInfo').classList.remove('hidden');
                document.getElementById('balanceInfo').classList.remove('hidden');
                
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                createBtn.disabled = currentChainId !== MONAD_CHAIN_ID;
            } else {
                statusElement.textContent = 'Not Connected';
                document.getElementById('addressInfo').classList.add('hidden');
                document.getElementById('networkInfo').classList.add('hidden');
                document.getElementById('balanceInfo').classList.add('hidden');
                
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                createBtn.disabled = true;
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            addLog('ğŸ”— å¼€å§‹è¿æ¥é’±åŒ…...');
            
            if (typeof window.ethereum === 'undefined') {
                addLog('âŒ æœªæ£€æµ‹åˆ°MetaMask');
                showStatus('è¯·å®‰è£…MetaMaské’±åŒ…', 'error');
                return;
            }

            try {
                // è¯·æ±‚è´¦æˆ·è®¿é—®
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts',
                });

                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    walletConnected = true;
                    
                    // è·å–å½“å‰ç½‘ç»œ
                    currentChainId = await window.ethereum.request({ 
                        method: 'eth_chainId' 
                    });
                    
                    addLog(`âœ… é’±åŒ…è¿æ¥æˆåŠŸ: ${userAddress}`);
                    addLog(`ğŸŒ å½“å‰ç½‘ç»œ: ${currentChainId}`);
                    
                    // è·å–ä½™é¢
                    try {
                        const balance = await window.ethereum.request({
                            method: 'eth_getBalance',
                            params: [userAddress, 'latest']
                        });
                        const balanceInEth = (parseInt(balance, 16) / Math.pow(10, 18)).toFixed(4);
                        document.getElementById('walletBalance').textContent = `${balanceInEth} MON`;
                        addLog(`ğŸ’° ä½™é¢: ${balanceInEth} MON`);
                    } catch (balanceError) {
                        addLog(`âš ï¸ è·å–ä½™é¢å¤±è´¥: ${balanceError.message}`);
                    }
                    
                    updateWalletUI();
                    showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                    
                    if (currentChainId !== MONAD_CHAIN_ID) {
                        showStatus('è¯·åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘', 'error');
                    }
                }
            } catch (error) {
                addLog(`âŒ è¿æ¥é’±åŒ…å¤±è´¥: ${error.message}`);
                showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ–­å¼€é’±åŒ…
        function disconnectWallet() {
            walletConnected = false;
            userAddress = '';
            currentChainId = '';
            updateWalletUI();
            hideStatus();
            addLog('ğŸ”Œ é’±åŒ…å·²æ–­å¼€è¿æ¥');
        }

        // åˆ›å»ºçº¢åŒ…ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function createRedPacket() {
            addLog('ğŸ å¼€å§‹åˆ›å»ºçº¢åŒ…...');
            
            if (!walletConnected) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            if (currentChainId !== MONAD_CHAIN_ID) {
                showStatus('è¯·åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘', 'error');
                return;
            }

            const recipient = document.getElementById('recipient').value;
            const amount = parseFloat(document.getElementById('amount').value);

            // éªŒè¯è¾“å…¥
            if (!recipient || recipient.length !== 42) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¥æ”¶è€…åœ°å€', 'error');
                return;
            }

            if (amount <= 0) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', 'error');
                return;
            }

            const createBtn = document.getElementById('createBtn');
            createBtn.textContent = 'CREATING...';
            createBtn.disabled = true;
            hideStatus();

            try {
                addLog(`ğŸ“ æ¥æ”¶è€…: ${recipient}`);
                addLog(`ğŸ“ é‡‘é¢: ${amount} MON`);
                
                // ç®€åŒ–çš„äº¤æ˜“å‚æ•°ï¼ˆåªå‘é€åŸç”Ÿä»£å¸ï¼Œä¸è°ƒç”¨åˆçº¦ï¼‰
                const amountInWei = BigInt(Math.floor(amount * Math.pow(10, 18)));
                
                addLog(`ğŸ“ é‡‘é¢(Wei): ${amountInWei.toString()}`);
                
                const txParams = {
                    to: recipient, // ç›´æ¥å‘é€ç»™æ¥æ”¶è€…ï¼Œè€Œä¸æ˜¯åˆçº¦
                    from: userAddress,
                    value: '0x' + amountInWei.toString(16),
                    gas: '0x5208' // 21000 gas for simple transfer
                };
                
                addLog('ğŸ“ å‘é€ç®€åŒ–äº¤æ˜“...');
                console.log('äº¤æ˜“å‚æ•°:', txParams);
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [txParams]
                });

                addLog(`ğŸ“ äº¤æ˜“å·²å‘é€: ${txHash}`);
                showStatus('äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('txHash').textContent = txHash;
                document.getElementById('txStatus').textContent = 'Pending';
                document.getElementById('blockNumber').textContent = 'Waiting...';
                document.getElementById('resultSection').classList.remove('hidden');
                
                // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                let attempts = 0;
                const maxAttempts = 30;
                
                const checkReceipt = async () => {
                    try {
                        const receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [txHash]
                        });
                        
                        if (receipt) {
                            addLog(`âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸ: ${receipt.blockNumber}`);
                            document.getElementById('txStatus').textContent = receipt.status === '0x1' ? 'Success' : 'Failed';
                            document.getElementById('blockNumber').textContent = parseInt(receipt.blockNumber, 16);
                            showStatus('äº¤æ˜“ç¡®è®¤æˆåŠŸï¼', 'success');
                        } else {
                            attempts++;
                            if (attempts < maxAttempts) {
                                addLog(`â³ ç­‰å¾…ç¡®è®¤... (${attempts}/${maxAttempts})`);
                                setTimeout(checkReceipt, 2000);
                            } else {
                                addLog('â° ç¡®è®¤è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨æŸ¥çœ‹äº¤æ˜“çŠ¶æ€');
                                showStatus('ç¡®è®¤è¶…æ—¶ï¼Œè¯·æŸ¥çœ‹é’±åŒ…', 'error');
                            }
                        }
                    } catch (error) {
                        addLog(`âŒ æŸ¥è¯¢äº¤æ˜“çŠ¶æ€å¤±è´¥: ${error.message}`);
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(checkReceipt, 2000);
                        }
                    }
                };
                
                setTimeout(checkReceipt, 2000);

            } catch (error) {
                addLog(`âŒ åˆ›å»ºçº¢åŒ…å¤±è´¥: ${error.message}`);
                console.error('è¯¦ç»†é”™è¯¯:', error);
                
                if (error.code === 4001) {
                    showStatus('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error');
                } else if (error.code === -32603) {
                    showStatus('å†…éƒ¨JSON-RPCé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                } else if (error.message.includes('insufficient funds')) {
                    showStatus('ä½™é¢ä¸è¶³', 'error');
                } else {
                    showStatus(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                }
            } finally {
                createBtn.textContent = 'CREATE RED PACKET';
                createBtn.disabled = !walletConnected || currentChainId !== MONAD_CHAIN_ID;
            }
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (accounts[0] !== userAddress) {
                    userAddress = accounts[0];
                    addLog(`ğŸ”„ è´¦æˆ·å·²åˆ‡æ¢: ${userAddress}`);
                    updateWalletUI();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                currentChainId = chainId;
                addLog(`ğŸ”„ ç½‘ç»œå·²åˆ‡æ¢: ${chainId}`);
                updateWalletUI();
                
                if (chainId === MONAD_CHAIN_ID) {
                    showStatus('å·²åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘', 'success');
                } else {
                    showStatus('è¯·åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘', 'error');
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            addLog(`ğŸ“ åˆçº¦åœ°å€: ${CONTRACT_ADDRESS}`);
            addLog(`ğŸ“ ç›®æ ‡ç½‘ç»œ: Monad Testnet (${MONAD_CHAIN_ID})`);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectWallet);
            document.getElementById('createBtn').addEventListener('click', createRedPacket);
            
            updateWalletUI();
            addLog('âœ… ç®€åŒ–æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
