# Makefile for the MonaPacket Foundry project

#------------------------------------------------------------------
# VARIABLES
#------------------------------------------------------------------
-include .env
export

VERBOSITY = -vvvv
MONAD_VERIFIER_URL = 'https://sourcify-api-monad.blockvision.org'

#------------------------------------------------------------------
# STANDARD COMMANDS
#------------------------------------------------------------------
all: build
install:
	@echo "=============== üì• Installing Dependencies ==============="
	@forge install
build: clean
	@echo "=============== üî® Building Contracts ==============="
	@forge build
test:
	@echo "=============== üß™ Running Tests ==============="
	@forge test
clean:
	@echo "=============== üßπ Cleaning Build Artifacts ==============="
	@forge clean

#------------------------------------------------------------------
# DEPLOYMENT COMMANDS (Âè™ÈÉ®ÁΩ≤Ôºå‰∏çÈ™åËØÅ)
#------------------------------------------------------------------
deploy-app-local: build
	@echo "=============== üöÄ Deploying MonaPacket App to Local Anvil ==============="
	@forge script script/MonaPacket.s.sol:MonaPacketScript --rpc-url $(LOCAL_RPC_URL) --private-key $(PRIVATE_KEY) --broadcast $(VERBOSITY)
	@make extract-all-abis

deploy-token-local: build
	@echo "=============== ü™ô Deploying MonaPacketToken to Local Anvil ==============="
	@forge script script/MonaPacketToken.s.sol:MonaPacketTokenScript --rpc-url $(LOCAL_RPC_URL) --private-key $(PRIVATE_KEY) --broadcast $(VERBOSITY)
	@make extract-abi-token

deploy-app-monad-testnet: build
	@echo "=============== üöÄ Deploying MonaPacket App to Monad Testnet ==============="
	@forge script script/MonaPacket.s.sol:MonaPacketScript --rpc-url $(MONAD_RPC_URL) --private-key $(PRIVATE_KEY) --broadcast --legacy $(VERBOSITY)
	@make extract-all-abis

deploy-token-monad-testnet: build
	@echo "=============== ü™ô Deploying MonaPacketToken to Monad Testnet ==============="
	@forge script script/MonaPacketToken.s.sol:MonaPacketTokenScript --rpc-url $(MONAD_RPC_URL) --private-key $(PRIVATE_KEY) --broadcast --legacy $(VERBOSITY)
	@make extract-abi-token

#------------------------------------------------------------------
# VERIFICATION COMMANDS (Áã¨Á´ãÈ™åËØÅ)
#------------------------------------------------------------------
# ‰ΩøÁî®ÊñπÊ≥ï: make verify-monad-testnet address=<ÂêàÁ∫¶Âú∞ÂùÄ> contract=MonaPacket
verify-monad-testnet:
	@echo "=============== üîé Verifying $(contract) at $(address) on Monad Testnet ==============="
	@forge verify-contract \
		--rpc-url $(MONAD_RPC_URL) \
		--verifier sourcify \
		--verifier-url $(MONAD_VERIFIER_URL) \
		$(address) \
		src/$(contract).sol:$(contract) \
		$(VERBOSITY)

#------------------------------------------------------------------
# ABI EXTRACTION COMMANDS
#------------------------------------------------------------------
extract-all-abis: extract-abi-monapacket extract-abi-monapacketnft extract-abi-monapacketaccount
	@echo "=============== ‚úÖ All App ABIs extracted successfully! ==============="
extract-abi-monapacket:
	@mkdir -p abis; cp out/MonaPacket.sol/MonaPacket.json abis/MonaPacket.json
extract-abi-monapacketnft:
	@mkdir -p abis; cp out/MonaPacketNFT.sol/MonaPacketNFT.json abis/MonaPacketNFT.json
extract-abi-monapacketaccount:
	@mkdir -p abis; cp out/MonaPacketAccount.sol/MonaPacketAccount.json abis/MonaPacketAccount.json
extract-abi-token:
	@mkdir -p abis; cp out/MonaPacketToken.sol/MonaPacketToken.json abis/MonaPacketToken.json

.PHONY: all install build test clean deploy-app-local deploy-token-local deploy-app-monad-testnet deploy-token-monad-testnet verify-monad-testnet extract-all-abis extract-abi-monapacket extract-abi-monapacketnft extract-abi-monapacketaccount extract-abi-token